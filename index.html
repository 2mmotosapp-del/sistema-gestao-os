<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Gerenciamento - Clientes, Custos e Itens (Atualizado)</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Layout e Estilos Modernizados */
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef1f5; }
        header { background: #003366; color: white; padding: 15px 20px; font-size: 22px; font-weight: 600; text-align:center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sidebar { width: 260px; height: 100vh; background: #1f2a44; color: white; padding-top: 20px; position: fixed; top: 0; left: 0; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
        .sidebar h3 { padding: 0 22px; margin-top: 5px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 10px; color: #aaa; font-size: 16px; font-weight: normal; }
        .menu-item { padding: 14px 22px; cursor: pointer; transition: background 0.25s, color 0.25s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .menu-item:hover { background: #33415c; color: #fff; }
        .submenu { background: #27324a; display: none; }
        .submenu .menu-item { padding-left: 45px; font-size: 14px; }
        .content { margin-left: 280px; padding: 30px; }
        .card, .table-box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 1100px; margin-bottom: 25px; }
        label { font-weight: 600; margin-top: 15px; display: block; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; transition: border-color 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #003366; outline: none; }
        .input-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .input-group > div { flex: 1; min-width: 250px; }
        button { margin-top: 20px; padding: 12px 18px; background: #003366; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s; font-weight: bold; }
        button:hover { background: #0a4a8f; }
        
        /* Tabelas */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #f0f3f7; font-weight: 600; color: #333; }
        tr:hover { background: #f9f9f9; }
        
        /* Filtros */
        .filters { padding: 10px; border: 1px solid #eee; border-radius: 6px; background: #fbfbfb; }
        .filters input, .filters select { width: 100%; padding: 8px; border-radius: 4px; }
        
        /* Dashboard */
        .dashboard-box { display: flex; gap: 20px; flex-wrap:wrap; justify-content: space-between; }
        .dash { background: white; padding: 20px; border-radius: 10px; width: 220px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #003366; transition: transform 0.2s; }
        .dash:hover { transform: translateY(-3px); }
        .dash h1 { font-size: 38px; margin: 5px 0; }
        .small { font-size: 13px; color:#666; margin-top:6px; }
        
        /* Bot√µes de A√ß√£o */
        .btn-small { padding:8px 12px; font-size:14px; border-radius:6px; margin-top: 5px; display: inline-block; }
        .btn-action { margin: 0 2px; padding: 7px 12px; font-size: 13px; font-weight: normal; }
        .btn-add-item { background: #28a745; margin-top: 10px; padding: 8px 15px; }
        .btn-add-item:hover { background: #218838; }
        
        hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 450px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); text-align: left; }
        .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; line-height: 1; }
        .close:hover, .close:focus { color: #333; text-decoration: none; cursor: pointer; }

        /* Estilo para Totais */
        .total-display { font-size: 24px; font-weight: bold; color: #003366; margin-top: 10px; display: block; }

        /* ------------------------------------------- */
        /* MEDIA QUERIES PARA RESPONSIVIDADE (Ajustado) */
        /* ------------------------------------------- */
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .content { margin-left: 0; padding: 15px; }
            .dashboard-box { flex-direction: column; gap: 15px; }
            .dash { width: 100% !important; box-sizing: border-box; border-left-width: 10px; }
            .input-group > div { min-width: 100%; }
            .input-group { gap: 0; }
            .filters { flex-direction: column; gap: 10px !important; }
            .table-box { overflow-x: auto; }
            .table-box table { min-width: 700px; }
        }
    </style>
</head>
<body>
<header>Sistema ‚Äì Gerenciamento de Clientes e Custos</header>

<div class="sidebar">
    <h3>Menu Principal</h3>
    <div class="menu-item" onclick="toggle('cadastro')">üìù Clientes (OS)</div>
    <div id="cadastro" class="submenu" style="display:block;">
        <div class="menu-item" onclick="abrirTela('telaCadastro')">Nova Ordem de Servi√ßo</div>
        <div class="menu-item" onclick="abrirTela('telaClientes')">Ordens de Servi√ßo</div>
    </div>
    
    <div class="menu-item" onclick="toggle('itens')">‚öôÔ∏è Itens/Servi√ßos</div>
    <div id="itens" class="submenu">
        <div class="menu-item" onclick="abrirTela('telaCadastroItem')">Cadastrar Item</div>
        <div class="menu-item" onclick="abrirTela('telaListaItens')">Listar Itens</div>
    </div>

    <div class="menu-item" onclick="toggle('custos')">üí∞ Custos</div>
    <div id="custos" class="submenu">
        <div class="menu-item" onclick="abrirTela('telaNovoCusto')">Registrar Custo</div>
        <div class="menu-item" onclick="abrirTela('telaListaCustos')">Listar Custos</div>
    </div>

    <div class="menu-item" onclick="abrirTela('telaResultadosCustos')">üìä Resultados & An√°lise</div>
</div>

<div class="content">
    <h2>Painel do Sistema</h2>
    <p>Selecione uma op√ß√£o no menu lateral para come√ßar.</p>

    <div id="telaCadastro" class="card" style="display:none;">
        <h2>Nova Ordem de Servi√ßo</h2>
        <div class="input-group">
            <div>
                <label>Data:</label>
                <input type="date" id="dataCadastro">
            </div>
            <div>
                <label>Cliente:</label>
                <input id="cliente">
            </div>
        </div>
        
        <div class="input-group">
            <div>
                <label>Tipo:</label>
                <select id="tipo">
                    <option value="garantia">Garantia</option>
                    <option value="preparacao">Prepara√ß√£o</option>
                </select>
            </div>
            <div>
                <label>Status:</label>
                <select id="status">
                    <option>Aguardando</option>
                    <option>Em espera</option>
                    <option>Montagem</option>
                    <option>Pe√ßas</option>
                    <option>Pronto</option>
                    <option>Teste</option>
                    <option>Ret√≠fica</option>
                </select>
            </div>
        </div>

        <div class="input-group">
            <div>
                <label>Placa:</label>
                <input id="placa" maxlength="7" placeholder="Ex: ABC1234">
            </div>
            <div>
                <label>Marca:</label>
                <input id="marca">
            </div>
            <div>
                <label>Modelo:</label>
                <input id="modelo">
            </div>
        </div>
        
        <div class="input-group">
            <div>
                <label>KM Entrada:</label>
                <input type="number" id="kmEntrada" min="0">
            </div>
            <div>
                <label>KM Venda:</label>
                <input type="number" id="kmVenda" min="0">
            </div>
            <div>
                <label>Data da Venda:</label>
                <input type="date" id="dataVenda">
            </div>
        </div>

        <label>Defeito Reclamado:</label>
        <input id="defeito">
        <label>Avaria Encontrada:</label>
        <input id="avaria">
        <label>Detalhes da Avaria:</label>
        <textarea id="detalhesAvaria" rows="3"></textarea>
        <label>Reparo/Servi√ßo Realizado:</label>
        <input id="reparo">
        <label>Mec√¢nico Respons√°vel:</label>
        <input id="mecanico">
        <label>Observa√ß√£o Adicional:</label>
        <textarea id="observacao" rows="3"></textarea>
        <button onclick="salvarCadastro()">Salvar Ordem de Servi√ßo (OS)</button>
    </div>

    <div id="telaClientes" class="table-box" style="display:none;">
        <h2>Ordens de Servi√ßo Cadastradas</h2>
        <div class="filters" style="margin-bottom:15px; display:flex; gap:10px;">
            <input id="filtroID" placeholder="Filtrar por OS ID" onkeyup="filtrarClientes()" style="flex:1;">
            <input id="filtroNome" placeholder="Filtrar por cliente" onkeyup="filtrarClientes()" style="flex:2;">
            <select id="filtroTipo" onchange="filtrarClientes()" style="flex:1;">
                <option value="">-- Todos os Tipos --</option>
                <option value="garantia">Garantia</option>
                <option value="preparacao">Prepara√ß√£o</option>
            </select>
            <input id="filtroPlaca" placeholder="Filtrar por placa" onkeyup="filtrarClientes()" style="flex:1;">
        </div>
        <table>
            <thead>
                <tr>
                    <th>OS ID</th>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Status</th>
                    <th>Placa</th>
                    <th>Reparo</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaClientes"></tbody>
        </table>
    </div>
    
    <div id="telaCadastroItem" class="card" style="display:none;">
        <h2>Cadastro de Item/Servi√ßo</h2>
        <label>Nome do Item/Servi√ßo:</label>
        <input id="itemNome">
        <input type="hidden" id="itemPreco" value="0"> <label>Tipo:</label>
        <select id="itemTipo">
            <option value="Peca">Pe√ßa</option>
            <option value="Servico">Servi√ßo</option>
            <option value="MaoDeObra">M√£o de Obra</option>
            <option value="Outros">Outros</option>
        </select>
        <button onclick="salvarItem()">Salvar Item/Servi√ßo</button>
    </div>

    <div id="telaListaItens" class="table-box" style="display:none;">
        <h2>Itens/Servi√ßos Cadastrados</h2>
        <table>
            <thead><tr><th>Nome</th><th>Tipo</th><th>Pre√ßo Sugerido (R$)</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tabelaItens"></tbody>
        </table>
    </div>

    <div id="telaNovoCusto" class="card" style="display:none;">
        <h2>Registrar Novo Custo</h2>

        <div class="input-group">
            <div>
                <label>Categoria do Custo:</label>
                <select id="custoCategoria">
                    <option value="Operacional">Operacional</option>
                    <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                    <option value="Pessoal">Pessoal</option>
                    <option value="Impostos">Impostos</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            <div>
                <label>Data do Custo:</label>
                <input type="date" id="custoData">
            </div>
        </div>

        <hr>
        
        <label>Vincular a OS/Cliente (Opcional):</label>
        <div class="input-group">
            <div>
                <label style="margin-top:0;">Placa da OS:</label>
                <select id="custoPlaca" onchange="vincularClientePorPlaca()">
                    <option value="">-- Selecione uma Placa --</option>
                </select>
            </div>
            <div>
                <label style="margin-top:0;">Nome do Cliente:</label>
                <input id="custoCliente" placeholder="Preenchido pela Placa ou Manualmente">
            </div>
        </div>

        <hr>

        <h3>Adicionar Itens do Custo</h3>

        <label>Item Cadastrado (Sugest√£o de Nome):</label>
        <select id="itemDescricaoSelect" onchange="preencherValorItem()">
            <option value="">-- Selecione um Item Cadastrado --</option>
        </select>
        
        <label>Descri√ß√£o Personalizada (detalhe a compra):</label>
        <input type="text" id="itemDescricaoInput" placeholder="Ex: √ìleo 5w30, Aluguel do M√™s">

        <div class="input-group">
            <div>
                <label>Quantidade:</label>
                <input type="number" id="itemQuantidade" min="1" value="1" step="0.01">
            </div>
            <div>
                <label>Valor Unit√°rio (R$):</label>
                <input type="number" id="itemValor" min="0" step="0.01" placeholder="Ex: 50.00">
            </div>
        </div>
        
        <button onclick="adicionarItemCusto()" class="btn-small btn-add-item">‚ûï Adicionar Item √† Lista</button>

        <hr>

        <h3>Itens Adicionados a este Custo</h3>
        <table style="width:100%;">
            <thead>
                <tr>
                    <th>Descri√ß√£o</th>
                    <th>Qtd</th>
                    <th>V. Unit√°rio (R$)</th>
                    <th>Total Item (R$)</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="listaItensCusto"></tbody>
        </table>

        <p>Total do Custo:</p>
        <span id="totalCusto" class="total-display">R$ 0,00</span>

        <button onclick="salvarCusto()">üíæ Registrar Custo Total</button>
    </div>

    <div id="telaListaCustos" class="table-box" style="display:none;">
        <h2>Custos Registrados</h2>
        <div class="filters" style="display:flex; gap:10px; margin-bottom:15px;">
            <input id="filtroCustoDesc" placeholder="Descri√ß√£o/Cliente" onkeyup="filtrarCustos()" style="flex:2;">
            <input id="filtroCustoPlaca" placeholder="Placa" onkeyup="filtrarCustos()" style="flex:1;">
            <select id="filtroCustoCat" onchange="filtrarCustos()" style="flex:1;">
                <option value="">-- Categoria --</option>
                <option value="Operacional">Operacional</option>
                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                <option value="Pessoal">Pessoal</option>
                <option value="Impostos">Impostos</option>
                <option value="Outros">Outros</option>
            </select>
            <input id="filtroCustoData" type="date" onchange="filtrarCustos()" style="flex:1;">
        </div>
        <table>
            <thead><tr><th>Data</th><th>Cliente/Placa</th><th>Descri√ß√£o (Itens)</th><th>Categoria</th><th>Valor Total (R$)</th><th>A√ß√µes</th></tr></thead>
            <tbody id="tabelaCustos"></tbody>
        </table>
        <p style="margin-top:20px;">Soma dos Custos Exibidos: <strong id="somaCustosFiltro">R$ 0,00</strong></p>
    </div>

    <div id="telaResultadosCustos" style="display:none;">
        <h2>üìä An√°lise de Custos e Atividades</h2>
        <div class="dashboard-box">
            <div class="dash" style="border-color:#cc0000;">
                <p class="small">Total Geral de Custos</p>
                <h1 id="totalGeralCustos" style="color: #cc0000;">R$ 0,00</h1>
            </div>

            <div class="dash" style="border-color:#007bff;">
                <p class="small">Quantidade Total de Ordens (OS)</p>
                <h1 id="totalOrdens">0</h1>
            </div>

            <div class="dash" style="border-color:#28a745;">
                <p class="small">OSs Prontas (Status 'Pronto')</p>
                <h1 id="ordensPronto">0</h1>
            </div>

            <div class="dash" style="width:250px; border-color:#ffc107;">
                <p class="small">üèÜ Top 1 Mec√¢nico (OS Cadastradas)</p>
                <h1 id="topMecanico1">N/A</h1>
                <p class="small" id="topMecanico1Count"></p>
            </div>
            <div class="dash" style="width:200px; border-color:#6c757d;">
                <p class="small">2¬∫ e 3¬∫ Mec√¢nicos</p>
                <p style="margin:5px 0; font-size:14px;" id="topMecanico2">2¬∫: N/A</p>
                <p style="margin:5px 0; font-size:14px;" id="topMecanico3">3¬∫: N/A</p>
            </div>
            
            <div class="dash" style="width:200px; border-color:#17a2b8;">
                <p class="small">Top 3 Itens em Custos (Qtd.)</p>
                <p style="margin:5px 0; font-weight:bold; font-size:14px;" id="topItem1">1¬∫: N/A</p>
                <p style="margin:5px 0; font-size:14px;" id="topItem2">2¬∫: N/A</p>
                <p style="margin:5px 0; font-size:14px;" id="topItem3">3¬∫: N/A</p>
            </div>
        </div>

        <div class="table-box" style="margin-top: 30px; max-width: 700px;">
            <h3>üí∞ Top 5 Custos por Item (Soma de Valores)</h3>
            <table>
                <thead><tr><th>Descri√ß√£o</th><th>Valor Total (R$)</th></tr></thead>
                <tbody id="tabelaTopCustos"></tbody>
            </table>
        </div>

        <div class="table-box" style="margin-top: 20px; max-width: 700px;">
            <h3>üîé Top 5 Servi√ßos (Defeito/Avaria/Reparo) em OS</h3>
            <table>
                <thead><tr><th>Item</th><th>Ocorr√™ncias</th></tr></thead>
                <tbody id="tabelaTopItensServicos"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalStatus" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('modalStatus').style.display='none';">&times;</span>
        <h2>Atualizar Status da OS</h2>
        <p>OS ID: <strong id="modalOsId"></strong><br>Cliente: <span id="modalOsCliente"></span></p>

        <label>Novo Status:</label>
        <select id="modalNovoStatus">
            <option>Aguardando</option>
            <option>Em espera</option>
            <option>Montagem</option>
            <option>Pe√ßas</option>
            <option>Pronto</option>
            <option>Teste</option>
            <option>Ret√≠fica</option>
        </select>
        
        <p style="font-size:12px; margin-top:15px; color:#555;">O hist√≥rico de status ser√° atualizado com a data e hora atuais.</p>

        <button onclick="salvarNovoStatus()">Atualizar Status</button>
    </div>
</div>

<script>
// -------------------- FIREBASE CONFIG --------------------
const firebaseConfig = {
    apiKey: "INSIRA_SUA_API_KEY_AQUI",
    authDomain: "INSIRA_SEU_AUTH_DOMAIN_AQUI",
    projectId: "INSIRA_SEU_PROJECT_ID_AQUI",
    storageBucket: "INSIRA_SEU_STORAGE_BUCKET_AQUI",
    messagingSenderId: "INSIRA_SEU_MESSAGING_SENDER_ID_AQUI",
    appId: "INSIRA_SEU_APP_ID_AQUI"
};

let db;
let app;

try {
    // Inicializa o Firebase apenas se n√£o estiver inicializado
    if (!firebase.apps.length) {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(app);
    } else {
        app = firebase.app();
        db = firebase.firestore(app);
    }
} catch (err) {
    console.error("Erro ao inicializar Firebase:", err);
    alert("Erro ao conectar com o Firebase. Verifique suas credenciais no c√≥digo.");
}

// listas locais
let listaClientes = []; // Dados de OS/Clientes
let listaCustos = []; // Dados de Custos
let listaItens = []; // Dados de Itens/Servi√ßos

// Vari√°veis de estado
let idOSParaAtualizar = null; // Para o modal de status
let itensCustoTemp = []; // Para o registro de custos em andamento

// utilit√°rios de UI
function toggle(id){ const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
function formatarMoeda(valor) {
    if (typeof valor !== 'number' || isNaN(valor)) return 'R$ 0,00';
    return `R$ ${valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
}
function limparFormOS() {
    document.getElementById('dataCadastro').value = '';
    document.getElementById('cliente').value = '';
    document.getElementById('tipo').value = 'garantia';
    document.getElementById('status').value = 'Aguardando';
    document.getElementById('placa').value = '';
    document.getElementById('marca').value = '';
    document.getElementById('modelo').value = '';
    document.getElementById('kmEntrada').value = '';
    document.getElementById('kmVenda').value = '';
    document.getElementById('dataVenda').value = '';
    document.getElementById('defeito').value = '';
    document.getElementById('avaria').value = '';
    document.getElementById('detalhesAvaria').value = '';
    document.getElementById('reparo').value = '';
    document.getElementById('mecanico').value = '';
    document.getElementById('observacao').value = '';
}

function abrirTela(t){
    // Oculta todas as telas exceto o cabe√ßalho e menu
    document.querySelectorAll('.content > div[id^="tela"], .content > .card, .content > .table-box').forEach(el=>el.style.display='none');
    
    document.getElementById(t).style.display='block';
    
    // Chamadas de carregamento de dados
    if(t === 'telaClientes') carregarClientes();
    if(t === 'telaNovoCusto') prepararNovoCusto();
    if(t === 'telaListaCustos') carregarCustos();
    if(t === 'telaCadastroItem') limparFormItem();
    if(t === 'telaListaItens') carregarItens();
    if(t === 'telaResultadosCustos') carregarDashboardCustos();
    
    if (window.innerWidth <= 1024) {
        document.querySelector('.content').scrollTop = 0;
    }
}

// -------------------- M√ìDULO CLIENTES (ORDEM DE SERVI√áO) --------------------
async function salvarCadastro(){
    const data = document.getElementById('dataCadastro').value || '';
    const cliente = document.getElementById('cliente').value.trim();
    const tipo = document.getElementById('tipo').value;
    const status = document.getElementById('status').value;
    const placa = document.getElementById('placa').value.trim().toUpperCase().replace(/[^A-Z0-9]/g, ''); // Limpa e padroniza placa
    const marca = document.getElementById('marca').value.trim();
    const modelo = document.getElementById('modelo').value.trim();
    const kmEntrada = document.getElementById('kmEntrada').value || '';
    const kmVenda = document.getElementById('kmVenda').value || '';
    const dataVenda = document.getElementById('dataVenda').value || '';
    const defeito = document.getElementById('defeito').value.trim();
    const avaria = document.getElementById('avaria').value.trim();
    const detalhesAvaria = document.getElementById('detalhesAvaria').value.trim();
    const reparo = document.getElementById('reparo').value.trim();
    const mecanico = document.getElementById('mecanico').value.trim();
    const observacao = document.getElementById('observacao').value.trim();

    if(!cliente || !placa){
        alert('Por favor preencha pelo menos Cliente e Placa.');
        return;
    }
    
    const statusRecord = {
        status: status,
        timestamp: new Date().toLocaleString('pt-BR')
    };

    const doc = {
        data: data || new Date().toISOString().split('T')[0],
        cliente, tipo, status, placa, marca, modelo, dataVenda, defeito, avaria, detalhesAvaria, reparo, mecanico, observacao,
        kmEntrada: kmEntrada === '' ? null : Number(kmEntrada),
        kmVenda: kmVenda === '' ? null : Number(kmVenda),
        statusHistory: [statusRecord],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('clientes').add(doc);
        alert('Cadastro salvo com sucesso! O sistema ir√° para a lista de OS.');
        limparFormOS();
        abrirTela('telaClientes');
    } catch (e) {
        console.error('Erro ao salvar cliente/OS:', e);
        alert('Erro ao salvar cliente/OS. Verifique console.');
    }
}

async function carregarClientes(){
    try {
        // Ordena por data decrescente (mais recente primeiro)
        const snapshot = await db.collection('clientes').orderBy('data','desc').get();
        listaClientes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        atualizarTabelaClientes();
        popularSelectPlacas(); // Atualiza a lista de placas para o cadastro de custos
    } catch (e) {
        console.error('Erro ao carregar clientes/OS:', e);
        listaClientes = [];
    }
}

function atualizarTabelaClientes(clientes = listaClientes){
    const corpo = document.getElementById('tabelaClientes');
    if(!corpo) return;
    corpo.innerHTML = clientes.map(c => `
        <tr>
            <td>**${c.id.substring(0, 6).toUpperCase()}**</td>
            <td>${c.data || 'N/A'}</td>
            <td>${c.cliente || 'N/A'}</td>
            <td>${c.tipo || 'N/A'}</td>
            <td><strong style="color:${c.status === 'Pronto' ? '#28a745' : '#003366'};">${c.status || 'N/A'}</strong></td>
            <td>${c.placa || 'N/A'}</td>
            <td>${c.reparo || 'N/A'}</td>
            <td>
                <button class="btn-action" style="background:#28a745;" onclick="abrirModalStatus('${c.id}', '${c.cliente.replace(/'/g, "\\'")}', '${c.status}')">Status</button>
                <button class="btn-action" style="background:#dc3545;" onclick="removerOS('${c.id}')">Remover</button>
            </td>
        </tr>
    `).join('');
}

function filtrarClientes(){
    const id = (document.getElementById('filtroID').value || '').toLowerCase();
    const n = (document.getElementById('filtroNome').value || '').toLowerCase();
    const t = (document.getElementById('filtroTipo').value || '').toLowerCase();
    const p = (document.getElementById('filtroPlaca').value || '').toLowerCase();

    const filtrados = listaClientes.filter(c =>
        (c.id || '').toLowerCase().includes(id) &&
        (c.cliente || '').toLowerCase().includes(n) &&
        (c.tipo || '').toLowerCase().includes(t) &&
        (c.placa || '').toLowerCase().includes(p)
    );
    atualizarTabelaClientes(filtrados);
}

// === FUN√á√ïES DE A√á√ÉO DA OS ===
function abrirModalStatus(id, cliente, statusAtual) {
    idOSParaAtualizar = id;
    document.getElementById('modalOsId').textContent = id.substring(0, 6).toUpperCase();
    document.getElementById('modalOsCliente').textContent = cliente;
    document.getElementById('modalNovoStatus').value = statusAtual;
    document.getElementById('modalStatus').style.display = 'block';
}

async function salvarNovoStatus() {
    if (!idOSParaAtualizar) return;
    const novoStatus = document.getElementById('modalNovoStatus').value;
    
    const clienteOS = listaClientes.find(c => c.id === idOSParaAtualizar);

    if (clienteOS && clienteOS.status === novoStatus) {
        alert('O status selecionado √© o mesmo atual.');
        document.getElementById('modalStatus').style.display = 'none';
        idOSParaAtualizar = null;
        return;
    }

    const statusRecord = {
        status: novoStatus,
        timestamp: new Date().toLocaleString('pt-BR')
    };

    try {
        await db.collection('clientes').doc(idOSParaAtualizar).update({ 
            status: novoStatus,
            statusHistory: firebase.firestore.FieldValue.arrayUnion(statusRecord)
        });
        
        alert(`Status da OS ${idOSParaAtualizar.substring(0, 6).toUpperCase()} atualizado para: ${novoStatus}`);
        document.getElementById('modalStatus').style.display = 'none';
        idOSParaAtualizar = null;
        carregarClientes(); // Recarrega para atualizar a tabela
    } catch (e) {
        console.error('Erro ao atualizar status:', e);
        alert('Erro ao atualizar status da OS.');
    }
}

async function removerOS(id) {
    if (confirm(`Tem certeza que deseja remover a OS ${id.substring(0, 6).toUpperCase()}? Essa a√ß√£o √© irrevers√≠vel e remover√° todos os dados da OS!`)) {
        try {
            await db.collection('clientes').doc(id).delete();
            alert('Ordem de Servi√ßo removida com sucesso!');
            carregarClientes();
        } catch (e) {
            console.error('Erro ao remover OS:', e);
            alert('Erro ao remover Ordem de Servi√ßo.');
        }
    }
}

// -------------------- M√ìDULO: CADASTRO DE ITENS/SERVI√áOS --------------------

function limparFormItem() {
    document.getElementById('itemNome').value = '';
    document.getElementById('itemTipo').value = 'Peca';
}

async function salvarItem() {
    const nome = document.getElementById('itemNome').value.trim();
    const preco = 0; // Valor fixo/default mantido do original
    const tipo = document.getElementById('itemTipo').value;

    if (!nome) {
        alert('Preencha o Nome do Item/Servi√ßo.');
        return;
    }

    const itemDoc = {
        nome,
        preco: preco,
        tipo,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('itens').add(itemDoc);
        alert('Item/Servi√ßo salvo com sucesso! O sistema ir√° para a lista de Itens.');
        limparFormItem();
        carregarItens();
        abrirTela('telaListaItens');
    } catch (e) {
        console.error('Erro ao salvar item:', e);
        alert('Erro ao salvar item/servi√ßo.');
    }
}

async function carregarItens() {
    try {
        const snapshot = await db.collection('itens').orderBy('nome', 'asc').get();
        listaItens = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        atualizarTabelaItens();
        popularSelectItens(); // Atualiza a lista de itens para o cadastro de custos
    } catch (e) {
        console.error('Erro ao carregar itens:', e);
        listaItens = [];
    }
}

function atualizarTabelaItens(itens = listaItens) {
    const corpo = document.getElementById('tabelaItens');
    if(!corpo) return;
    corpo.innerHTML = itens.map(i => `
        <tr>
            <td>${i.nome}</td>
            <td>${i.tipo}</td>
            <td>${formatarMoeda(i.preco)}</td>
            <td>
                <button class="btn-small" style="background:#dc3545;" onclick="removerItem('${i.id}')">Remover</button>
            </td>
        </tr>
    `).join('');
}

async function removerItem(id) {
    if (confirm('Tem certeza que deseja remover este Item/Servi√ßo?')) {
        try {
            await db.collection('itens').doc(id).delete();
            alert('Item/Servi√ßo removido com sucesso!');
            carregarItens();
        } catch (e) {
            console.error('Erro ao remover item:', e);
            alert('Erro ao remover item.');
        }
    }
}

// -------------------- M√ìDULO DE CUSTOS --------------------

function prepararNovoCusto() {
    // Garante que as listas de apoio est√£o carregadas ou em processo
    if (listaClientes.length === 0) carregarClientes();
    if (listaItens.length === 0) carregarItens();
    
    // Reseta o estado do formul√°rio de custos
    itensCustoTemp = [];
    atualizarListaItensCusto(); // Limpa a tabela de itens tempor√°rios
    
    // Limpa campos principais do formul√°rio de custo
    document.getElementById('custoData').value = new Date().toISOString().split('T')[0];
    document.getElementById('custoPlaca').value = '';
    document.getElementById('custoCliente').value = '';
    
    // Limpa os campos de adi√ß√£o de item
    document.getElementById("itemDescricaoSelect").value = "";
    document.getElementById("itemDescricaoInput").value = "";
    document.getElementById("itemQuantidade").value = "1";
    document.getElementById("itemValor").value = "";
    document.getElementById('custoCategoria').value = 'Operacional';

}

function popularSelectPlacas() {
    const select = document.getElementById('custoPlaca');
    select.innerHTML = '<option value="">-- Selecione uma Placa --</option>';
    
    const placasMap = {};
    listaClientes.forEach(c => {
        if (c.placa && c.placa.trim() !== '') {
            // Prioriza o cliente da OS mais recente (a listaClientes j√° est√° ordenada por data decrescente)
            if (!placasMap[c.placa]) {
                placasMap[c.placa] = c.cliente;
            }
        }
    });

    Object.keys(placasMap).sort().forEach(placa => {
        const option = document.createElement('option');
        option.value = placa;
        option.textContent = `${placa} (${placasMap[placa]})`;
        select.appendChild(option);
    });
}

function vincularClientePorPlaca() {
    const placaSelecionada = document.getElementById('custoPlaca').value;
    const campoCliente = document.getElementById('custoCliente');
    
    if (placaSelecionada === '') {
        campoCliente.value = '';
        return;
    }
    
    // A lista est√° ordenada por data decrescente, o primeiro √© o mais recente.
    const clienteAssociado = listaClientes
        .find(c => c.placa === placaSelecionada);

    if (clienteAssociado) {
        campoCliente.value = clienteAssociado.cliente;
    } else {
        campoCliente.value = '';
    }
}

function popularSelectItens() {
    const select = document.getElementById('itemDescricaoSelect');
    select.innerHTML = '<option value="">-- Selecione um Item Cadastrado --</option>';
    
    listaItens.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(i => {
        const option = document.createElement('option');
        option.value = i.id;
        option.textContent = `${i.nome} (${i.tipo})`;
        select.appendChild(option);
    });
}

// Preenche o campo de valor (embora seja 0, √© bom ter a fun√ß√£o se o pre√ßo for implementado depois)
function preencherValorItem() {
    const itemId = document.getElementById('itemDescricaoSelect').value;
    const itemEncontrado = listaItens.find(i => i.id === itemId);
    
    // Mantido o placeholder de pre√ßo para o futuro, mas n√£o √© usado na l√≥gica de custo.
    document.getElementById("itemDescricaoInput").value = itemEncontrado ? itemEncontrado.nome : '';
}

function adicionarItemCusto() {
    let descricaoItem = document.getElementById("itemDescricaoInput").value.trim();
    const itemId = document.getElementById("itemDescricaoSelect").value;
    const quantidade = parseFloat(document.getElementById("itemQuantidade").value);
    const valorUnitario = parseFloat(document.getElementById("itemValor").value);

    // Se um item cadastrado foi selecionado, mas a descri√ß√£o personalizada est√° vazia
    if (itemId && !descricaoItem) {
        const itemEncontrado = listaItens.find(i => i.id === itemId);
        if (itemEncontrado) {
            descricaoItem = itemEncontrado.nome; // Usa o nome do item cadastrado
        }
    }
    
    if (!descricaoItem) {
        alert("Por favor, preencha a Descri√ß√£o Personalizada ou selecione um Item Cadastrado.");
        return;
    }
    
    if (isNaN(quantidade) || quantidade <= 0) {
        alert("Quantidade inv√°lida. Deve ser um n√∫mero maior que zero.");
        return;
    }
    
    if (isNaN(valorUnitario) || valorUnitario < 0) {
        alert("Valor Unit√°rio inv√°lido. Deve ser um n√∫mero positivo.");
        return;
    }
    
    const novoItem = {
        descricao: descricaoItem,
        quantidade: quantidade,
        valorUnitario: valorUnitario,
        total: quantidade * valorUnitario
    };

    itensCustoTemp.push(novoItem);
    
    // Limpa campos de adi√ß√£o de item e atualiza a lista
    document.getElementById("itemDescricaoSelect").value = "";
    document.getElementById("itemDescricaoInput").value = "";
    document.getElementById("itemQuantidade").value = "1";
    document.getElementById("itemValor").value = "";
    
    atualizarListaItensCusto();
}

function removerItemCusto(index) {
    if (index >= 0 && index < itensCustoTemp.length) {
        itensCustoTemp.splice(index, 1);
        atualizarListaItensCusto();
    }
}

function atualizarListaItensCusto() {
    const corpo = document.getElementById('listaItensCusto');
    const totalSpan = document.getElementById('totalCusto');
    let totalGeral = 0;
    
    corpo.innerHTML = '';

    itensCustoTemp.forEach((item, index) => {
        totalGeral += item.total;
        
        const row = corpo.insertRow();
        row.innerHTML = `
            <td>${item.descricao}</td>
            <td>${item.quantidade.toFixed(2).replace('.', ',')}</td>
            <td>${formatarMoeda(item.valorUnitario).replace('R$ ', '')}</td>
            <td>${formatarMoeda(item.total).replace('R$ ', '')}</td>
            <td>
                <button class="btn-action" style="background:#dc3545; margin-top:0;" onclick="removerItemCusto(${index})">X</button>
            </td>
        `;
    });
    
    totalSpan.textContent = formatarMoeda(totalGeral);
}

async function salvarCusto() {
    if (itensCustoTemp.length === 0) {
        alert("Adicione pelo menos um item para registrar o custo.");
        return;
    }

    const dataCusto = document.getElementById('custoData').value || new Date().toISOString().split('T')[0];
    const categoria = document.getElementById('custoCategoria').value;
    const placa = document.getElementById('custoPlaca').value.trim().toUpperCase();
    const cliente = document.getElementById('custoCliente').value.trim();
    const valorTotal = itensCustoTemp.reduce((sum, item) => sum + item.total, 0);

    const custoDoc = {
        data: dataCusto,
        categoria,
        placa: placa || 'N/A', // Se n√£o tiver placa, marca como N/A
        cliente: cliente || 'N/A', // Se n√£o tiver cliente, marca como N/A
        itens: itensCustoTemp, // Array de itens
        valorTotal: valorTotal,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('custos').add(custoDoc);
        alert('Custo registrado com sucesso! O sistema ir√° para a lista de Custos.');
        prepararNovoCusto(); // Limpa e prepara o formul√°rio para um novo custo
        abrirTela('telaListaCustos');
    } catch (e) {
        console.error('Erro ao salvar custo:', e);
        alert('Erro ao registrar custo. Verifique console.');
    }
}

async function carregarCustos() {
    try {
        // Ordena por data decrescente
        const snapshot = await db.collection('custos').orderBy('data', 'desc').get();
        listaCustos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        atualizarTabelaCustos();
    } catch (e) {
        console.error('Erro ao carregar custos:', e);
        listaCustos = [];
    }
}

function atualizarTabelaCustos(custos = listaCustos) {
    const corpo = document.getElementById('tabelaCustos');
    const somaSpan = document.getElementById('somaCustosFiltro');
    if(!corpo) return;
    corpo.innerHTML = '';
    
    let somaTotal = 0;

    custos.forEach(c => {
        somaTotal += c.valorTotal || 0;
        const itemDescriptions = c.itens.map(i => `${i.descricao}`).join(' | ');

        const row = corpo.insertRow();
        row.innerHTML = `
            <td>${c.data || 'N/A'}</td>
            <td>**${c.cliente || 'N/A'}** / ${c.placa || 'N/A'}</td>
            <td title="${itemDescriptions}">${itemDescriptions.substring(0, 50)}${itemDescriptions.length > 50 ? '...' : ''}</td>
            <td>${c.categoria || 'N/A'}</td>
            <td style="color:#cc0000; font-weight:bold;">${formatarMoeda(c.valorTotal)}</td>
            <td>
                <button class="btn-action" style="background:#dc3545;" onclick="removerCusto('${c.id}')">Remover</button>
            </td>
        `;
    });

    somaSpan.textContent = formatarMoeda(somaTotal);
}

function filtrarCustos() {
    const desc = (document.getElementById('filtroCustoDesc').value || '').toLowerCase();
    const placa = (document.getElementById('filtroCustoPlaca').value || '').toLowerCase();
    const cat = (document.getElementById('filtroCustoCat').value || '').toLowerCase();
    const data = document.getElementById('filtroCustoData').value || '';

    const filtrados = listaCustos.filter(c => {
        const itemDesc = c.itens.map(i => i.descricao).join(' ').toLowerCase();
        
        return (c.cliente || '').toLowerCase().includes(desc) || // Filtra por cliente
               itemDesc.includes(desc) && // Filtra por item
               (c.placa || '').toLowerCase().includes(placa) &&
               (cat === '' || (c.categoria || '').toLowerCase() === cat) &&
               (data === '' || c.data === data);
    });
    atualizarTabelaCustos(filtrados);
}

async function removerCusto(id) {
    if (confirm('Tem certeza que deseja remover este registro de Custo? Essa a√ß√£o √© irrevers√≠vel!')) {
        try {
            await db.collection('custos').doc(id).delete();
            alert('Custo removido com sucesso!');
            carregarCustos();
        } catch (e) {
            console.error('Erro ao remover custo:', e);
            alert('Erro ao remover custo.');
        }
    }
}


// -------------------- M√ìDULO DE RESULTADOS/DASHBOARD --------------------

async function carregarDashboardCustos() {
    // Garante que todos os dados essenciais est√£o carregados
    if (listaClientes.length === 0) await carregarClientes();
    if (listaCustos.length === 0) await carregarCustos();
    
    // 1. Total Geral de Custos
    const totalGeralCustos = listaCustos.reduce((sum, c) => sum + (c.valorTotal || 0), 0);
    document.getElementById('totalGeralCustos').textContent = formatarMoeda(totalGeralCustos);

    // 2. Quantidade Total de Ordens (OS)
    document.getElementById('totalOrdens').textContent = listaClientes.length;

    // 3. OSs Prontas
    const ordensPronto = listaClientes.filter(c => c.status === 'Pronto').length;
    document.getElementById('ordensPronto').textContent = ordensPronto;

    // 4. Top Mec√¢nicos
    const contagemMecanicos = listaClientes.reduce((acc, c) => {
        const nome = (c.mecanico || 'N/A').trim();
        if (nome) acc[nome] = (acc[nome] || 0) + 1;
        return acc;
    }, {});
    
    const topMecanicos = Object.entries(contagemMecanicos).sort(([, a], [, b]) => b - a);
    
    document.getElementById('topMecanico1').textContent = topMecanicos[0] ? topMecanicos[0][0] : 'N/A';
    document.getElementById('topMecanico1Count').textContent = topMecanicos[0] ? `${topMecanicos[0][1]} OSs` : '';
    document.getElementById('topMecanico2').textContent = topMecanicos[1] ? `2¬∫: ${topMecanicos[1][0]} (${topMecanicos[1][1]} OSs)` : '2¬∫: N/A';
    document.getElementById('topMecanico3').textContent = topMecanicos[2] ? `3¬∫: ${topMecanicos[2][0]} (${topMecanicos[2][1]} OSs)` : '3¬∫: N/A';
    
    // 5. Top Itens em Custos (por Quantidade) e Top Custos por Valor
    const contagemItens = {};
    const somaValorItens = {};

    listaCustos.forEach(custo => {
        custo.itens.forEach(item => {
            const desc = (item.descricao || 'Item Desconhecido').trim();
            // Contagem por Quantidade
            contagemItens[desc] = (contagemItens[desc] || 0) + (item.quantidade || 0);
            // Soma por Valor
            somaValorItens[desc] = (somaValorItens[desc] || 0) + (item.total || 0);
        });
    });

    // Top 3 Itens em Quantidade
    const topItensQtd = Object.entries(contagemItens).sort(([, a], [, b]) => b - a);
    document.getElementById('topItem1').textContent = topItensQtd[0] ? `1¬∫: ${topItensQtd[0][0]} (${topItensQtd[0][1].toFixed(1).replace('.', ',')})` : '1¬∫: N/A';
    document.getElementById('topItem2').textContent = topItensQtd[1] ? `2¬∫: ${topItensQtd[1][0]} (${topItensQtd[1][1].toFixed(1).replace('.', ',')})` : '2¬∫: N/A';
    document.getElementById('topItem3').textContent = topItensQtd[2] ? `3¬∫: ${topItensQtd[2][0]} (${topItensQtd[2][1].toFixed(1).replace('.', ',')})` : '3¬∫: N/A';

    // Top 5 Custos por Valor
    const topCustosValor = Object.entries(somaValorItens).sort(([, a], [, b]) => b - a).slice(0, 5);
    const tabelaTopCustosCorpo = document.getElementById('tabelaTopCustos');
    tabelaTopCustosCorpo.innerHTML = topCustosValor.map(([desc, valor]) => `
        <tr>
            <td>${desc}</td>
            <td style="color:#cc0000; font-weight:bold;">${formatarMoeda(valor)}</td>
        </tr>
    `).join('');
    
    // 6. Top 5 Servi√ßos (Defeito/Avaria/Reparo)
    const contagemServicos = {};
    listaClientes.forEach(c => {
        // Agrega Defeito, Avaria, Reparo se existirem
        [c.defeito, c.avaria, c.reparo].forEach(item => {
            const servico = (item || '').trim();
            if (servico && servico !== 'N/A') {
                contagemServicos[servico] = (contagemServicos[servico] || 0) + 1;
            }
        });
    });

    const topServicos = Object.entries(contagemServicos).sort(([, a], [, b]) => b - a).slice(0, 5);
    const tabelaTopServicosCorpo = document.getElementById('tabelaTopItensServicos');
    tabelaTopServicosCorpo.innerHTML = topServicos.map(([servico, count]) => `
        <tr>
            <td>${servico}</td>
            <td>${count}</td>
        </tr>
    `).join('');
}

// Garante que a tela inicial de OS (ou qualquer outra) seja carregada na abertura
document.addEventListener('DOMContentLoaded', () => {
    // Tenta carregar os dados essenciais na inicializa√ß√£o
    carregarClientes();
    carregarItens();
    // Exibe a tela de Ordens de Servi√ßo por padr√£o ou a primeira tela do submenu aberto
    abrirTela('telaClientes'); 
});

</script>
</body>
</html>
